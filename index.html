<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Student Pathfinder (Netlify + Gemini)</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <main class="container">
    <h1>Student Pathfinder</h1>
    <p class="muted">Select group → enter subject marks → compute cutoff → AI suggests courses/colleges.</p>

    <!-- Step 1 -->
    <section id="s1" class="step">
      <h2>Which group did you study?</h2>
      <div class="buttons">
        <button onclick="chooseGroup('cs-maths')">CS - Maths</button>
        <button onclick="chooseGroup('bio-maths')">Bio - Maths</button>
        <button onclick="chooseGroup('pure-science')">Pure Science</button>
        <button onclick="chooseGroup('commerce')">Commerce</button>
        <button onclick="chooseGroup('business-maths')">Business Maths</button>
      </div>
    </section>

    <!-- Step 2: marks -->
    <form id="marksForm" class="step hidden" onsubmit="onSubmitMarks(event)">
      <div id="marksInputs"></div>
      <div class="row">
        <button type="button" class="btn-alt" onclick="showStep(1)">Back</button>
        <button type="submit">Compute & Next</button>
      </div>
    </form>

    <!-- Step 3: interests -->
    <section id="s3" class="step hidden">
      <h2>Pick interests (1–3)</h2>
      <div id="interestsList"></div>
      <div class="row">
        <button class="btn-alt" onclick="showStep(2)">Back</button>
        <button onclick="sendToAI()">Get AI Suggestions</button>
      </div>
    </section>

    <!-- Step 4: AI result -->
    <section id="s4" class="step hidden">
      <h2>AI Recommendations</h2>
      <div id="aiStatus" class="muted">Waiting for AI...</div>
      <pre id="aiOutput" class="output"></pre>
      <div class="row">
        <button class="btn-alt" onclick="restart()">Start Over</button>
      </div>
    </section>
  </main>

  <script>
  // ---------- state ----------
  let group = null;
  let marksObj = {};
  let computedCutoff = null;
  let chosenInterests = [];

  const subjectSets = {
    "cs-maths": ["Mathematics","Physics","Chemistry","ComputerScience"],
    "bio-maths": ["Mathematics","Physics","Chemistry","Biology"],
    "pure-science": ["Mathematics","Physics","Chemistry","AnyOtherScience"],
    "commerce": ["English","Accountancy","Economics","BusinessStudies"],
    "business-maths": ["Mathematics","BusinessStudies","Economics","English"]
  };

  const interestsByGroup = {
    "cs-maths": ["Programming","Engineering","Data Science","Robotics","Game Dev"],
    "bio-maths": ["Medicine","Biotech","Agriculture","Research","Pharma"],
    "pure-science": ["Research","Teaching","Lab Science","Environmental"],
    "commerce": ["Accounting","Finance","Economics","Management"],
    "business-maths": ["Management","Finance","Actuarial","Business Analytics"]
  };

  // ---------- UI helpers ----------
  function showStep(n) {
    document.querySelectorAll('.step, form').forEach(el => el.classList.add('hidden'));
    if (n===1) document.getElementById('s1').classList.remove('hidden');
    if (n===2) document.getElementById('marksForm').classList.remove('hidden');
    if (n===3) document.getElementById('s3').classList.remove('hidden');
    if (n===4) document.getElementById('s4').classList.remove('hidden');
  }

  function chooseGroup(g) {
    group = g; marksObj = {}; computedCutoff = null; chosenInterests = [];
    // render marks inputs
    const container = document.getElementById('marksInputs');
    container.innerHTML = "<h3>Enter marks (0-100)</h3>";
    subjectSets[g].forEach(s => {
      container.innerHTML += `<label>${s}: <input id="m_${s}" type="number" min="0" max="100" /></label>`;
    });
    showStep(2);
  }

  function onSubmitMarks(e) {
    e.preventDefault();
    subjectSets[group].forEach(s => {
      marksObj[s] = Number(document.getElementById('m_' + s).value || 0);
    });
    computedCutoff = computeCutoffFormula(group, marksObj);
    // render interests with cutoff info
    const il = document.getElementById('interestsList');
    il.innerHTML = `<p class="muted">Computed cutoff: <strong>${computedCutoff.score} / ${computedCutoff.max}</strong> (formula: ${computedCutoff.formula})</p>`;
    interestsByGroup[group].forEach(i => {
      il.innerHTML += `<label><input type="checkbox" value="${i}" onchange="toggleInterest(this)"/> ${i}</label><br>`;
    });
    showStep(3);
  }

  function toggleInterest(chk){
    const v = chk.value;
    if (chk.checked) chosenInterests.push(v);
    else chosenInterests = chosenInterests.filter(x=>x!==v);
  }

  function restart(){
    group = null; marksObj = {}; computedCutoff = null; chosenInterests = [];
    document.getElementById('aiOutput').textContent = '';
    showStep(1);
  }

  // ---------- cutoff formulas ----------
  function computeCutoffFormula(group, marks) {
    if (group === "cs-maths") {
      const m = marks["Mathematics"] || 0;
      const p = marks["Physics"] || 0;
      const c = marks["Chemistry"] || 0;
      const score = m + (p/2) + (c/2); // engineering-style example (out of 200)
      return { score: Math.round(score*100)/100, max: 200, formula: "Math + Physics/2 + Chemistry/2" };
    }
    if (group === "bio-maths") {
      const m = marks["Mathematics"] || 0, b = marks["Biology"] || 0;
      const score = (b*1.2) + (m*0.8);
      return { score: Math.round(score*100)/100, max: 220, formula: "1.2*Biology + 0.8*Math" };
    }
    if (group === "pure-science") {
      const m = marks["Mathematics"]||0, p=marks["Physics"]||0, c=marks["Chemistry"]||0;
      const score = m+p+c;
      return { score, max: 300, formula: "Math + Physics + Chemistry" };
    }
    // commerce / business maths
    const a = marks["Accountancy"]||0, e = marks["Economics"]||0, mm = marks["Mathematics"]||0;
    const score = (a*1.1) + (e*1.0) + (mm*0.9);
    return { score: Math.round(score*100)/100, max: 330, formula: "1.1*Acc + 1.0*Econ + 0.9*Math" };
  }

  // ---------- call Netlify function (Gemini) ----------
  async function sendToAI() {
    if (!group || !computedCutoff) { alert('Complete previous steps'); return; }
    const payload = { group, marksObj, computedCutoff, interests: chosenInterests };

    document.getElementById('aiStatus').textContent = 'Contacting AI...';
    showStep(4);
    document.getElementById('aiOutput').textContent = '';

    try {
      const res = await fetch('/.netlify/functions/recommend', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Server error');

      // data.ai_json if function returned parsed JSON suggestions; fallback to ai_text
      if (data.ai_json) {
        document.getElementById('aiOutput').textContent = JSON.stringify(data.ai_json, null, 2);
      } else {
        document.getElementById('aiOutput').textContent = data.ai_text || JSON.stringify(data, null, 2);
      }
      document.getElementById('aiStatus').textContent = 'Done';
    } catch (err) {
      document.getElementById('aiOutput').textContent = 'Error: ' + err.message;
      document.getElementById('aiStatus').textContent = 'Failed';
    }
  }

  // start
  showStep(1);
  </script>
</body>
</html>